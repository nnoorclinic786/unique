
/**
 * # Firestore Security Rules: WholesaleRx App
 *
 * ## Core Philosophy
 * This ruleset implements a hybrid security model combining Role-Based Access Control (RBAC) for administrators and a strict user-ownership model for buyers. The primary goal is to ensure that buyers can only access and manage their own data, while granting administrators the necessary privileges to manage the platform (e.g., approve buyer requests, manage the drug catalog) and view user data for support and fulfillment purposes.
 *
 * ## Data Structure
 * The data is organized into several top-level collections to segregate permissions effectively:
 * - `/roles_admin/{adminId}`: Manages admin roles using a Database-Based Access Control (DBAC) pattern. The existence of a document grants admin privileges. This collection is not client-writable by non-admins.
 * - `/admins/{adminId}`: Stores detailed admin user profiles, including permissions. Writable only by other admins or by a user creating their own doc.
 * - `/users/{userId}`: Stores approved buyer profiles. Each buyer has full control over their own document.
 * - `/buyer_requests/{requestId}`: A dedicated collection that acts as a queue for new buyer signups awaiting admin approval. This structural segregation simplifies rules.
 * - `/drugs/{drugId}`: The master drug catalog, readable by all authenticated users but writable only by administrators.
 * - `/orders/{orderId}`: A top-level collection for all orders. This supports admin queries. Buyer access is restricted at the document level.
 *
 * ## Key Security Decisions
 * - **Admin Role Management**: Admin access is determined by checking for a document in `/roles_admin/{uid}`. This is a performant and secure method that avoids reliance on custom claims.
 * - **Strict User Scoping**: Buyer-specific data in `/users/{userId}` ensures rules can easily enforce that a user can only access their own document.
 * - **No User Listing**: Listing all documents in the `/users` collection is explicitly disallowed to protect user privacy (except for admins).
 * - **Approval Queue**: New buyer registrations are created in a separate `/buyer_requests` collection. This is a deliberate choice for security and performance.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && exists(path(request.path));
    }
    
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    function isSuperAdminCreatingRole() {
        // This checks if the user making the request has the Super Admin email.
        // This is less secure than a custom claim but acceptable for this specific bootstrap action.
        return request.auth.token.email == 'uniquemedicare786@gmail.com';
    }


    // -------------------------------------------------------------------------
    // Collection Rules
    // -------------------------------------------------------------------------
    
    /**
     * Manages admin roles. Only a super admin can create their own initial role.
     * After that, this collection is read-only for security rule checks.
     */
    match /roles_admin/{adminId} {
      allow read: if isSignedIn();
      allow write: if false; // Generally no client-side writes
      allow create: if isSuperAdminCreatingRole() && isOwner(adminId);
    }
    
    /**
     * Stores admin profiles. Admins can manage other admins. New users can create their own profile.
     */
    match /admins/{adminId} {
      allow read, list, update: if isAdmin();
      allow create: if isOwner(adminId); // Allow a user to create their own admin document during signup
      allow delete: if isAdmin();
    }

    /**
     * Stores approved buyer profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false;
    }

    /**
     * Queue for new buyer signup requests.
     */
    match /buyer_requests/{requestId} {
      allow get, list, delete: if isAdmin();
      allow create: if isOwner(requestId); // A user can create their own request
      allow update: if false;
    }

    /**
     * The master catalog of drugs.
     */
    match /drugs/{drugId} {
      allow read, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * The collection of all orders.
     */
    match /orders/{orderId} {
        allow get: if isAdmin() || (isSignedIn() && resource.data.buyerId == request.auth.uid);
        allow list: if isAdmin() || (isSignedIn() && request.query.where.size() > 0 && request.query.where[0][0] == 'buyerId' && request.query.where[0][2] == request.auth.uid);
        allow create: if isSignedIn() && request.resource.data.buyerId == request.auth.uid;
        allow update: if isAdmin() || (isOwner(request.resource.data.buyerId) && resource.data.status == 'draft');
        allow delete: if isAdmin() || (isOwner(resource.data.buyerId) && resource.data.status == 'draft');
    }
  }
}

    